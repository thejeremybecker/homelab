version: '3.8'

services:

  mariadb-backup:
    image: mariadb:10.5
    container_name: mariadb-backup
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}   
    volumes:
      - ${APPDATA_PATH}/phpgl/backup:/backup                 
    networks:
      - phpgl_network                              
    entrypoint: /bin/sh
    command: -c "
      echo 'Waiting for MariaDB...';
      until mysql -h mariadb-phpgl -u root -p$MYSQL_ROOT_PASSWORD -e 'SELECT 1'; do
        sleep 5;
      done;
      echo 'MariaDB ready. Starting daily backups.';
      while true; do
        mysqldump -h mariadb-phpgl -u root -p$MYSQL_ROOT_PASSWORD phpgl > /backup/phpgl_$(date +'%Y%m%d_%H%M').sql;
        find /backup -type f -name '*.sql' -mtime +7 -delete;
        sleep 86400;
      done
    "
    depends_on:
      - mariadb-phpgl
    restart: unless-stopped

networks:
  phpgl_network:
    external: true
