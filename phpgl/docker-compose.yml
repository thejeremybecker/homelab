version: '3.8'
services:
  apache2-phpgl:
    image: mchauvel/php-pdo-mysql
    container_name: apache2-phpgl
    ports:
      - "8083:80"
    volumes:
      - ${APPDATA_PATH}/phpgl/apache2/html:/var/www/html
      - ${APPDATA_PATH}/phpgl/apache2/php.ini:/etc/php5/apache2/php.ini
      - ${APPDATA_PATH}/phpgl/apache2/php5/cli/php.ini:/etc/php5/cli/php.ini
      - ${APPDATA_PATH}/phpgl/apache2/apache_logs:/var/log/apache2
    links:
      - mariadb-phpgl
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    restart: always
    depends_on:
      - mariadb-phpgl

  mariadb-phpgl:
    image: mariadb:10.5
    container_name: mariadb-phpgl
    expose:
      - "3306"
    ports:
      - "3306:3306"  
    volumes:
      - mariadb_data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: phpgl
      MYSQL_USER: pygl
      MYSQL_PASSWORD: ${PYGL_PASSWORD}  
    restart: always

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    links:
      - mariadb-phpgl
    ports:
      - "9001:80"
    environment:
      PMA_HOSTS: mariadb-phpgl
    restart: always
    depends_on:
      - mariadb-phpgl
    container_name: phpmyadmin

  mariadb-backup:
    image: mariadb:10.5
    container_name: mariadb-backup
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    volumes:
      - mariadb_data:/var/lib/mysql         # access database
      - ${APPDATA_PATH}/phpgl/backup:/backup           # host backup folder
    entrypoint: /bin/sh
    command: -c "
      echo 'Waiting for MariaDB to be ready...';
      until mysql -h mariadb-phpgl -u root -p$MYSQL_ROOT_PASSWORD -e 'SELECT 1'; do
        sleep 5;
      done;
      echo 'MariaDB ready. Starting daily backups.';
      while true; do
        mysqldump -h mariadb-phpgl -u root -p$MYSQL_ROOT_PASSWORD phpgl > /backup/phpgl_$(date +'%Y%m%d_%H%M').sql;
        sleep 86400;
      done"
    depends_on:
      - mariadb-phpgl
    restart: unless-stopped
    
volumes:
  mariadb_data:
